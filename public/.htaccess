# Flood Doctor - Apache Configuration for SPA with Subdomains
# GoDaddy Shared Hosting

# Enable rewrite engine
RewriteEngine On
RewriteBase /

# Custom 404 page
ErrorDocument 404 /404.html

# HTTPS handled by Cloudflare at edge (Flexible SSL mode)
# DO NOT add HTTPS redirect here - causes redirect loop with Flexible SSL

# ============================================
# SUBDOMAIN ROUTING - City Sites
# ============================================
# Route city subdomains to their respective folders
# Each city has its own static build in /{city}/

# McLean
RewriteCond %{HTTP_HOST} ^mclean\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/mclean/
RewriteRule ^(.*)$ /mclean/$1 [L]

# Arlington
RewriteCond %{HTTP_HOST} ^arlington\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/arlington/
RewriteRule ^(.*)$ /arlington/$1 [L]

# Alexandria
RewriteCond %{HTTP_HOST} ^alexandria\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/alexandria/
RewriteRule ^(.*)$ /alexandria/$1 [L]

# Fairfax
RewriteCond %{HTTP_HOST} ^fairfax\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/fairfax/
RewriteRule ^(.*)$ /fairfax/$1 [L]

# Vienna
RewriteCond %{HTTP_HOST} ^vienna\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/vienna/
RewriteRule ^(.*)$ /vienna/$1 [L]

# Tysons
RewriteCond %{HTTP_HOST} ^tysons\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/tysons/
RewriteRule ^(.*)$ /tysons/$1 [L]

# Reston
RewriteCond %{HTTP_HOST} ^reston\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/reston/
RewriteRule ^(.*)$ /reston/$1 [L]

# Herndon
RewriteCond %{HTTP_HOST} ^herndon\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/herndon/
RewriteRule ^(.*)$ /herndon/$1 [L]

# Ashburn
RewriteCond %{HTTP_HOST} ^ashburn\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/ashburn/
RewriteRule ^(.*)$ /ashburn/$1 [L]

# Springfield
RewriteCond %{HTTP_HOST} ^springfield\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/springfield/
RewriteRule ^(.*)$ /springfield/$1 [L]

# Falls Church
RewriteCond %{HTTP_HOST} ^fallschurch\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/fallschurch/
RewriteRule ^(.*)$ /fallschurch/$1 [L]

# Great Falls
RewriteCond %{HTTP_HOST} ^greatfalls\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/greatfalls/
RewriteRule ^(.*)$ /greatfalls/$1 [L]

# Lorton
RewriteCond %{HTTP_HOST} ^lorton\.flood\.doctor$ [NC]
RewriteCond %{REQUEST_URI} !^/lorton/
RewriteRule ^(.*)$ /lorton/$1 [L]

# ============================================
# BLOCK CITY PATHS ON MAIN DOMAIN
# ============================================
# City content lives on subdomains (e.g. mclean.flood.doctor).
# Block flood.doctor/{city}/ paths to prevent 403 from directory listing.
RewriteCond %{HTTP_HOST} ^(www\.)?flood\.doctor$ [NC]
RewriteRule ^(mclean|arlington|alexandria|fairfax|vienna|tysons|reston|herndon|ashburn|springfield|fallschurch|greatfalls|lorton)(/.*)?$ - [R=404,L]

# ============================================
# 301 REDIRECTS - Non-canonical URLs
# ============================================
# /services/water-damage-restoration/ -> canonical nested route
RewriteRule ^services/water-damage-restoration/?$ /services/residential/restoration-services/water-damage-restoration/ [R=301,L]

# ============================================

# Security Headers
<IfModule mod_headers.c>
    Header set X-Frame-Options "DENY"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Permissions-Policy "camera=(), microphone=(), geolocation=()"
</IfModule>

# Cache static assets (1 year)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
</IfModule>

# Serve sitemaps with correct content type
<IfModule mod_mime.c>
    AddType application/xml .xml
</IfModule>

# Handle sitemap.xml -> sitemaps/sitemap-index.xml
RewriteRule ^sitemap\.xml$ /sitemaps/sitemap-index.xml [L]

# Serve static files directly if they exist
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ============================================
# 404 FOR NON-EXISTENT ROUTES
# ============================================
# All valid routes have prerendered static HTML files in dist/.
# Any request reaching here has no matching file â€” it's a true 404.
# Apache serves /404.html via ErrorDocument directive above.
RewriteRule ^ - [R=404,L]
